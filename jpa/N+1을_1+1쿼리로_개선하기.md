# N + 1 â†’ 1 + 1 ì¿¼ë¦¬ë¡œ ê°œì„ í•˜ê¸°

<br>

íŒ¨í„´í™” : N + 1 ì¿¼ë¦¬ë¥¼ whereì˜ inì ˆì„ ì‚¬ìš©í•´ 1 + 1 ì¿¼ë¦¬ë¡œ ê°œì„  ê°€ëŠ¥í•˜ë‹¤.

<br>

## ğŸ“Œ ìƒí™©
```java
// ì½”ë“œ ì˜ˆì‹œ
private HospitalNearResDto setHospitalResDto(HospitalNearResDto resDto) {
        HospitalWorktime worktime = hospitalWorktimeRepository.findByHospital_Id(resDto.getId()) //ì¶”ê°€ ì¿¼ë¦¬
                                        .orElse(HospitalWorktime.builder().build());
        HospitalWorktimeDto worktimeDto = HospitalWorktimeDtoMapper.INSTANCE.toDto(worktime);
        resDto.changeNowOpen(worktimeDto, resDto.getOperationStatusCd());   

        return resDto;
}
```

- ìœ„ì˜ ê¸°ì¡´ ì½”ë“œì—ì„œëŠ” HospitalNearResDto Listì˜ ì›ì†Œ ê°œìˆ˜ë§Œí¼ ë³‘ì›ì˜ ìš´ì˜ì •ë³´ë¥¼ ì¡°íšŒí•˜ëŠ” ìœ„ì˜ ì¶”ê°€ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•´ ì „í˜•ì ì¸ N+1 ìƒí™©ì´ì—ˆë‹¤.

<br>

## ğŸ“Œ ê°œì„ 
- ì²˜ìŒì—ëŠ” ë³‘ì› ì—”í‹°í‹° ì¡°íšŒ ì‹œ ë³‘ì› ìš´ì˜ì •ë³´ ì—”í‹°í‹°ë„ í•¨ê»˜ ì¡°íšŒí•˜ëŠ” ë°©ì•ˆì„ ìƒê°í–ˆì—ˆëŠ”ë°, íšŒì‚¬ ì½”ë“œë¥¼ ë¦¬íŒ©í† ë§í•  ë•Œì˜ ì œì•½ ìƒí™©ì´ ê¸°ì¡´ì˜ ì¡°íšŒ ì¿¼ë¦¬ë¥¼ ìˆ˜ì •í•  ìˆ˜ ì—†ë‹¤ëŠ” ê²ƒì´ì–´ì„œ ë‹¤ë¥¸ ë°©ì•ˆì„ ì‹œë„í•˜ì˜€ë‹¤.
- ë”°ë¼ì„œ ë³‘ì›ë³„ ìš´ì˜ ì •ë³´ ì¡°íšŒ ì‹œ where inì„ ì‚¬ìš©í•´ í•œ ë²ˆì˜ ì¶”ê°€ ì¿¼ë¦¬ë¡œ ì²˜ë¦¬í•˜ë„ë¡ ê°œì„ í•˜ì˜€ë‹¤.

```java
// Service ì˜ˆì‹œ 
private List<HospitalNearResDto> setNowOpen(List<HospitalNearResDto> resDtos, boolean isHoliday) {
        List<Long> ids = resDtos.stream().map(HospitalNearResDto::getId).collect(Collectors.toList());
        List<HospitalWorktime> hospitalWorktimes = hospitalRepository.findAllWorkTimeByIds(ids); //ì¶”ê°€ ì¿¼ë¦¬ í•œ ë²ˆ
        for (int i = 0; i < resDtos.size(); i++) {
            resDtos.get(i).changeNowOpen(hospitalWorktimes.get(i), resDtos.get(i).getOperationStatusCd(), isHoliday);
        }
        return resDtos;
}
```
```java
// Repository ì˜ˆì‹œ
@Query("select h.hospitalWorktime " +
            "from Hospital h " +
            "left outer join h.hospitalWorktime " +
            "where h.id in :ids")
List<HospitalWorktime> findAllWorkTimeByIds(List<Long> ids);
```

- ì‹¤í–‰ ì¿¼ë¦¬ í™•ì¸

![image](https://user-images.githubusercontent.com/69254943/180234338-2d1b141a-704b-45bc-b720-d835657d6557.png)

- ì´í›„ Postmanìœ¼ë¡œ í•´ë‹¹ API ì‘ë‹µ ì†ë„ë¥¼ ë¹„êµí•´ë³´ë‹ˆ 568ms â†’ 524msë¡œ ê°œì„ ë˜ì—ˆë‹¤.

<br>

### ğŸ“Œ ì•Œê²Œëœ ì 
- ìƒí™©ì— ë§ëŠ” ê°œì„  ë°©ì•ˆì„ ì°¾ì•„ ì ìš©í•˜ëŠ”ê²Œ ì¤‘ìš”í•¨ì„ ì•Œê²Œ ë˜ì—ˆë‹¤.